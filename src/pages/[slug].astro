---
import LegalLayout from '../layouts/Legal.astro'
import PageLayout from '../layouts/Page.astro'
import { getPage, isPublished, hasPermalink } from '../utils/cms.ts'

type AstroPage = {
  content: {
    html: string
  }
}

export async function getStaticPaths() {
  const pages = Astro.fetchContent('../data/pages/*.md')
    .filter(isPublished)
    .filter(page => !hasPermalink('/')(page))
    .map(getPage)

  const paths = pages.map((page: CMS.Page) => {
    return {
      params: {
        slug: page.permalink.slice(1)
      },
      props: page
    }
  })

  return paths
}

const page = Astro.props as CMS.Page

function isContentPage(page: CMS.Page): page is CMS.ContentPage {
  return page.template === 'page'
}

function isLegalPage(page: CMS.Page): page is CMS.LegalPage {
  return page.template === 'legal'
}

const Layout = isContentPage(page) ? PageLayout
  : isLegalPage(page) ? LegalLayout
  : PageLayout
---

<Layout {...page}>
  {page.content}
</Layout>